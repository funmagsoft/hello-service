name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: "Build (CI)"
    uses: funmagsoft/github-actions-templates/.github/workflows/build.yml@main

    with:
      app_name: hello-service

    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  deploy-to-dev:
    name: "Deploy to Dev (GitOps)"
    needs: build
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Trigger GitOps deployment
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITOPS_PAT }}
          repository: funmagsoft/gitops
          event-type: deploy
          client-payload: |
            {
              "app_name": "hello-service",
              "environment": "dev",
              "image_tag": "${{ needs.build.outputs.image_tag }}",
              "acr_server": "${{ vars.ACR_LOGIN_SERVER }}"
            }

      - name: Deployment triggered
        run: |
          echo "### âœ… GitOps Deployment Triggered" >> $GITHUB_STEP_SUMMARY
          echo "- **App**: hello-service" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: dev" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ needs.build.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View deployment workflow](https://github.com/funmagsoft/gitops/actions/workflows/deploy.yml)" >> $GITHUB_STEP_SUMMARY
