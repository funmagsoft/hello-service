name: Release to Prod (GitOps)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  IMAGE_NAME: ${{ vars.IMAGE_NAME || github.event.repository.name }}
  ENV_REPO: ${{ secrets.ENV_REPO }}
  ENV_REPO_BRANCH: ${{ secrets.ENV_REPO_BRANCH || 'main' }}
  PRD_PATH: ${{ secrets.PRD_PATH || 'environments/prd' }}

jobs:
  build-push-and-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build (tests skipped, artifact for image)
        run: mvn -B -DskipTests package

      - name: Azure Container Registry login
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Compute tags
        id: meta
        run: |
          TAG=${GITHUB_REF_NAME}
          SHA_TAG=${GITHUB_SHA::7}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "sha_tag=$SHA_TAG" >> $GITHUB_OUTPUT
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT

      - name: Build and push versioned images
        run: |
          docker build -t ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }} -t ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.sha_tag }} .
          docker push ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}
          docker push ${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.sha_tag }}

      - name: Prepare env repo working copy
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ENV_REPO }}
          token: ${{ secrets.ENV_REPO_TOKEN }}
          path: env-repo
          ref: ${{ env.ENV_REPO_BRANCH }}

      - name: Bump image in prd (Kustomize or Helm)
        working-directory: env-repo
        run: |
          set -euo pipefail

          # Kustomize images section
          if [ -f "${{ env.PRD_PATH }}/kustomization.yaml" ]; then
            echo "Detected Kustomize overlay. Updating image tag..."
            if command -v yq >/dev/null 2>&1; then
              yq -i '(.images[] | select(.name == "'"${{ steps.meta.outputs.image }}"'") | .newTag) = "'"${{ steps.meta.outputs.tag }}"'" ${{ env.PRD_PATH }}/kustomization.yaml || true
            else
              sed -i.bak "s#\(${REGISTRY}/${IMAGE_NAME}:\)[A-Za-z0-9_.-]\+#\1${{ steps.meta.outputs.tag }}#g" ${{ env.PRD_PATH }}/kustomization.yaml || true
            fi
          fi

          # Helm values.yaml pattern
          if [ -f "${{ env.PRD_PATH }}/values.yaml" ]; then
            echo "Detected Helm values. Updating image tag..."
            if command -v yq >/dev/null 2>&1; then
              yq -i '.image.registry = "'"${{ env.REGISTRY }}"'"' ${{ env.PRD_PATH }}/values.yaml || true
              yq -i '.image.repository = "'"${{ env.IMAGE_NAME }}"'"' ${{ env.PRD_PATH }}/values.yaml || true
              yq -i '.image.tag = "'"${{ steps.meta.outputs.tag }}"'"' ${{ env.PRD_PATH }}/values.yaml || true
            else
              sed -i.bak "s#^\s*registry:.*#registry: ${REGISTRY}#" ${{ env.PRD_PATH }}/values.yaml || true
              sed -i.bak "s#^\s*repository:.*#repository: ${IMAGE_NAME}#" ${{ env.PRD_PATH }}/values.yaml || true
              sed -i.bak "s#^\s*tag:.*#tag: ${{ steps.meta.outputs.tag }}#" ${{ env.PRD_PATH }}/values.yaml || true
            fi
          fi

          # Generic manifest replacement
          if [ -d "${{ env.PRD_PATH }}" ]; then
            grep -RIl "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:" "${{ env.PRD_PATH }}" | while read -r f; do
              sed -i.bak "s#${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:[a-zA-Z0-9_.-]\+#${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}#g" "$f" || true
            done
          fi

      - name: Create PR to env repo (prd)
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.ENV_REPO_TOKEN }}
          path: env-repo
          commit-message: "release(prd): bump ${{ env.IMAGE_NAME }} to ${{ steps.meta.outputs.tag }}"
          title: "release(prd): bump ${{ env.IMAGE_NAME }} to ${{ steps.meta.outputs.tag }}"
          body: |
            Production release promotion via tag.

            Image: `${{ steps.meta.outputs.image }}:${{ steps.meta.outputs.tag }}`
          branch: release/bump-${{ env.IMAGE_NAME }}-prd-${{ steps.meta.outputs.tag }}
          base: ${{ env.ENV_REPO_BRANCH }}
          labels: |
            release
            production
